<app-nav-bar></app-nav-bar>

<section class="page">
  <header class="page__header">
    <h1>Timpi Ã®nregistraÈ›i de {{ pilotName }}</h1>
    <p class="muted">
      Total: {{ times.length }} tur{{ times.length === 1 ? '' : 'uri' }} Ã®nregistrate pe diverse circuite.
    </p>
  </header>

  <div class="toolbar">
    <button class="btn ghost" (click)="router.navigate(['/pilot'])">â† Ãnapoi la PiloÈ›i</button>

    <select [(ngModel)]="sortBy" (change)="applySort()" class="sel">
      <option value="time">SorteazÄƒ: Cel mai rapid timp</option>
      <option value="date">SorteazÄƒ: Data (cel mai recent)</option>
    </select>

    <button class="btn" *ngIf="canEditPage()" (click)="cancelEdit()">
      {{ showForm ? 'AnuleazÄƒ' : 'AdaugÄƒ timp' }}
    </button>
  </div>

  <form class="add-time" *ngIf="showForm && canEditPage()" (ngSubmit)="submitForm()">
    <h3 style="margin-top:0; margin-bottom: 1rem; color: white;">
        {{ editingTimeId ? 'âœï¸ ModificÄƒ timpul' : 'â• AdaugÄƒ timp nou' }}
    </h3>
    
    <div class="row">
      <select 
          [(ngModel)]="form.circuitId" 
          name="circuitId" 
          (change)="onCircuitChange()" 
          required 
          class="sel" 
          style="flex: 1; min-width: 150px; margin-right: 1rem;"
          [disabled]="editingTimeId !== null">
          
          <option [ngValue]="null" disabled>Alege un circuit...</option>
          <option *ngFor="let c of circuits" [ngValue]="c.id">
            {{ c.name }}
          </option>
      </select>

      <input 
          type="text" 
          placeholder="Èšara se completeazÄƒ automat" 
          [(ngModel)]="form.country" 
          name="country" 
          readonly 
          style="opacity: 0.7; cursor: not-allowed; flex: 1;" 
      />
    </div>

    <div class="row">
      <input type="text" placeholder="Sector 1 (MM:SS.mmm sau ms)" [(ngModel)]="form.sector1" name="sector1" required />
      <input type="text" placeholder="Sector 2 (MM:SS.mmm sau ms)" [(ngModel)]="form.sector2" name="sector2" required />
      <input type="text" placeholder="Sector 3 (MM:SS.mmm sau ms)" [(ngModel)]="form.sector3" name="sector3" required />
      
      <button class="btn" type="submit">
          {{ editingTimeId ? 'ActualizeazÄƒ' : 'SalveazÄƒ' }}
      </button>
    </div>
    <p class="muted">Exemple: <code>00:25.340</code> sau <code>25340</code> (ms) pentru fiecare sector</p>
  </form>

  <div class="empty" *ngIf="loading">
    <p>Se Ã®ncarcÄƒ timpii pilotului {{ pilotName }}...</p>
    <div class="skeleton-table"></div>
  </div>

  <div class="empty" *ngIf="!loading && times.length === 0">
    <div class="empty__card">
      <h3>Niciun timp Ã®nregistrat</h3>
      <p class="muted">Pilotul {{ pilotName }} nu are Ã®ncÄƒ timpi Ã®n baza de date.</p>
    </div>
  </div>

  <div class="table-container" *ngIf="!loading && times.length">
    <table class="data-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Circuit</th>
          <th>ÈšarÄƒ</th>
          <th>Sector 1</th>
          <th>Sector 2</th>
          <th>Sector 3</th>
          <th>Timp Total</th>
          <th>Data</th>
          <th *ngIf="canEditPage()">AcÈ›iuni</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let time of times; let i = index" [class.editing-row]="time.id === editingTimeId">
          <td><span class="rank" *ngIf="i === 0">ğŸ†</span><span *ngIf="i > 0">{{ i + 1 }}</span></td>
          <td>{{ time.circuit.name }}</td>
          <td>{{ time.circuit.country }}</td>
          <td><span class="sector-time">{{ formatSectorTime(time.sector1Ms) }}</span></td>
          <td><span class="sector-time">{{ formatSectorTime(time.sector2Ms) }}</span></td>
          <td><span class="sector-time">{{ formatSectorTime(time.sector3Ms) }}</span></td>
          <td><span class="lap-time" [class.best-lap]="i === 0">{{ formatLapTime(time.lapTimeMs) }}</span></td>
          <td>{{ time.createdAt | date: 'mediumDate' }}</td>
          
          <td *ngIf="canEditPage()">
            <div style="display: flex; gap: 0.5rem;">
                <button 
                  class="btn btn-edit" 
                  *ngIf="canDeleteTime(time)"
                  (click)="startEdit(time)"
                  title="ModificÄƒ"
                >
                  âœï¸
                </button>

                <button 
                  class="btn btn-delete" 
                  *ngIf="canDeleteTime(time)"
                  (click)="deleteTime(time.id)"
                  title="È˜terge"
                >
                  ğŸ—‘ï¸
                </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<app-footer></app-footer>