<app-nav-bar></app-nav-bar>

<section class="page">
  <header class="page__header">
    <div>
      <h1>Circuite F1</h1>
      <p class="muted">
        {{ filtered.length }} circuit{{ filtered.length === 1 ? '' : 'e' }} gÄƒsit{{ filtered.length === 1 ? '' : 'e' }}.
      </p>
    </div>

    <div class="toolbar">
      <div class="search">
        <input
          type="text"
          placeholder="CautÄƒ dupÄƒ nume sau È›arÄƒâ€¦"
          [(ngModel)]="q"
          (input)="applyFilters()"
        />
        <span class="kbd">/</span>
      </div>

      <select [(ngModel)]="sortBy" (change)="applyFilters()" class="sel">
        <option value="name">SorteazÄƒ: Nume (Aâ€“Z)</option>
        <option value="km">SorteazÄƒ: Km (mic â†’ mare)</option>
      </select>

      <button class="btn ghost" (click)="clearFilters()" [disabled]="!q && !country">
        Reset filtre
      </button>

      <!-- Buton AdaugÄƒ circuit (doar Admin) -->
      <button class="btn" *ngIf="isAdminUser && !showForm" (click)="showForm = true">
        + AdaugÄƒ circuit
      </button>
    </div>
  </header>

  <!-- Formular adÄƒugare/editare circuit (doar Admin) -->
  <form class="add-time" *ngIf="showForm && isAdminUser" (ngSubmit)="submitNewCircuit()">
    <div class="row">
      <input type="text" placeholder="Nume circuit (ex. Monaco)" [(ngModel)]="form.name" name="name" required />
      <input type="number" placeholder="Km (ex. 3.337)" [(ngModel)]="form.km" name="km" step="0.001" required />
      <input type="text" placeholder="ÈšarÄƒ (ex. Monaco)" [(ngModel)]="form.country" name="country" required />
      <button class="btn" type="submit">
        {{ editingCircuitId !== null ? 'ActualizeazÄƒ' : 'SalveazÄƒ' }}
      </button>
      <button class="btn ghost" type="button" (click)="cancelEdit()">AnuleazÄƒ</button>
    </div>
    <p class="muted" *ngIf="editingCircuitId !== null">Editezi circuitul</p>
  </form>

  <div class="chips" *ngIf="countries.length">
    <button
      class="chip"
      [class.chip--active]="country === ''"
      (click)="setCountry('')"
    >Toate</button>

    <button
      class="chip"
      *ngFor="let c of countries"
      [class.chip--active]="country === c"
      (click)="setCountry(c)"
      [title]="c"
    >
      {{ c }}
    </button>
  </div>

  <div class="empty" *ngIf="!loading && filtered.length === 0">
    <div class="empty__card">
      <h3>Nu am gÄƒsit nimic</h3>
      <p class="muted">ÃncearcÄƒ alt termen de cÄƒutare sau scoate filtrele.</p>
      <button class="btn" (click)="clearFilters()">ReseteazÄƒ filtrele</button>
    </div>
  </div>

  <div class="grid" *ngIf="!loading && filtered.length">
    <article class="card" *ngFor="let c of filtered"> 
      <!-- NOU: Imaginea circuitului -->
      <div class="card__image">
        <img [src]="getCircuitImageUrl(c)" [alt]="c.name" />
        
        <!-- Upload imagine (doar Admin) -->
        <div class="image-upload" *ngIf="isAdminUser">
          <input 
            type="file" 
            accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
            (change)="onCircuitFileSelected($event, c.id)" 
            [id]="'file-' + c.id"
            style="display: none;"
          />
          <label [for]="'file-' + c.id" class="btn btn-upload small">
            {{ uploading && uploadingCircuitId === c.id ? 'â³' : 'ğŸ“·' }} 
            {{ uploading && uploadingCircuitId === c.id ? 'Se Ã®ncarcÄƒ...' : 'SchimbÄƒ imagine' }}
          </label>
        </div>
      </div>

      <div class="card__head">
        <h3 class="card__title">{{ c.name }}</h3>
        <span class="badge">{{ c.country }}</span>
      </div>

      <div class="card__meta">
        <span class="meta">
          <svg viewBox="0 0 24 24" class="i"><path d="M7 19h10M12 4v12"></path></svg>
          {{ c.km | number:'1.3-3' }} km
        </span>
      </div>

      <div class="card__actions">
        <button class="btn small" (click)="circuiteDetails(c.id, c.name)">Detalii</button>
        
        <!-- Buton Edit (doar Admin) -->
        <button 
          class="btn btn-edit small" 
          *ngIf="isAdminUser" 
          (click)="startEdit(c)"
        >
          âœï¸ Edit
        </button>

        <!-- Buton È˜terge (doar Admin) -->
        <button 
          class="btn btn-delete small" 
          *ngIf="isAdminUser" 
          (click)="deleteCircuit(c.id, c.name)"
        >
          ğŸ—‘ï¸ È˜terge
        </button>
      </div>
    </article>
  </div>

  <div class="grid" *ngIf="loading">
    <div class="skeleton" *ngFor="let _ of [0,1,2,3,4,5,6,7]"></div>
  </div>
</section>

<app-footer></app-footer>